---
title: "Programming Language Compensation Gap"
subtitle: "DA2/C2 - Term Project"
author: "Son Nam Nguyen"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    toc: true
---

```{r chunks, echo=F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, fig.asp = 0.5, fig.width = 7, out.width = "90%" )
```

## Setup

```{r setup}

#setwd("~/Desktop/repos/c2-nyse-term-project")

# Loading packages with pacman
if (!require("pacman")) {
  install.packages("pacman")
}

pacman::p_load(tidyverse, modelsummary, kableExtra, fixest, estimatr, mfx, data.table, janitor, stringr, Hmisc)

df <- read.table("stack-overflow-developer-survey-2021/survey_results.gz", header = TRUE, sep=",", quote = "\"", fill=TRUE)

```
## Introduction

In this use-case, I will perform a throughout analysis on the programming language compensation gap among full-time developers in the United States. My aim is to show the expected differences in compensation depending on one knowing Python, SQL, R, etc. controlled with employment, education and demographics confounders.

## Source Description

For the analysis, I have used the [Stackoverflow Developer Survey](https://insights.stackoverflow.com/survey/2021) conducted in 2021. This report is based on a survey of 83,439 software developers from 181 countries around the world. Respondents were recruited primarily through channels owned by Stack Overflow. The top sources of respondents were onsite messaging, blog posts, email lists, banner ads, and social media posts.

## Data Quality

I consider the sample to be representative for the community. First, because it reaches out to potential respondent though an extensive number of channels. Yes, these mediums all assume that developers all have access to network connection, have their email, etc., but it very rare that people in the IT sector don't have those. Addtionally, observations and the diversity all across the globe should well support my subsequent arguments.

Looking back to surveys from previous years, the company made multiple modifications over the years to minimize the measurement errors in the variables. That is, instead of letting the respondents give arbitrary answers for questions like age, they categorized the variable into bins to avoid age discrepancies, at a cost of hindering the granularity of age coefficients. 

A possible window for error could be recognized in the reported level of compensation. People who believe that they are underpaid are less likely to report their wage, while those who are paid higher than average are more than happy to show off. Also, I need to identify reported compensations which are not plausible given the employment.

The dataset lacks a variable which lets me determine the coding years spent with the programming languages. Therefore, it is unknown what share of their professional career was spent on working with the listed languages someone has worked with so far. Therefore, I can't estimate the coefficients for what should we expect compensation-wise when working an additional year with a language.

Lastly, job titles have always been very difficult to grasp. Titles often does not reflect what a professional usually does in a day-to-day workday. Many job titles are not segregated enough from each other, hence, they tend to blend together. In other words there are rarely cases when the sets of job responsibilities are mutually exclusive. 

## Variables

Let us shortly clarify variables which are not that trivial what they present. Each variable represent an entry in the survey which you can find [here](https://github.com/nszoni/da2-c1-term-project/blob/main/stack-overflow-developer-survey-2021/so_survey_2021.pdf). 

Salaries are converted from user currencies to USD using the exchange rate on 2021-06-16, and also converted to annual salaries assuming 12 working months and 50 working weeks.

I will use the log of converted yearly compensations in thousand USD as my LHS variable.

Control variables which I will focus on are (1) Field of employment, (2) Size of organization, (3) Level of education (4) Gender, (5) Age, (6) number of known programming languages. I have also restricted the number of languages under scope to Python, SQL and R.

## Data Munging

To clean the raw data, I performed the following transformations:

1. Dropped of columns not needed in the further analysis
2. Regroup `Organization Size`, `DevType`, and `Gender` variables to decrease the number of factor levels.
3. Cast the variables to their appropriate class
4. Flip empty fields, "Prefer not to say" and its synonyms to NAs

Calculate new dimensions for:

1. Binary flags for working in coding languages (Python, R, SQL)
2. Count of coding languages an individual has worked with
3. Compensation represented in thousand USDs and its log form


```{r dataclean}

df_clean <- df %>% filter(Country == "United States of America" & Employment == "Employed full-time")

target <- c("EdLevel", "YearsCode", "DevType", "OrgSize", "LanguageHaveWorkedWith", "Age", "Gender", "ConvertedCompYearly", "US_State")

df_clean <- df_clean[ ,which((names(df_clean) %in% target)==TRUE)]

#Data cleaning
df_clean <- df_clean %>%
      mutate(
        CompSize = ifelse(OrgSize %in% c("Just me - I am a freelancer, sole proprietor, etc.", "10 to 19 employees", "2 to 9 employees"), "small", 
                          ifelse(OrgSize %in% c("20 to 99 employees","500 to 999 employees", "1,000 to 4,999 employees"), "medium", 
                                 ifelse(OrgSize %in% c("1,000 to 4,999 employees", "5,000 to 9,999 employees", "10,000 or more employees"), "large", NA))),
        YearsCode = as.numeric(YearsCode),
        ConvertedCompYearlyK = as.numeric(ConvertedCompYearly)/1000,
        lConvertedCompYearlyK = log(ConvertedCompYearlyK),
        Python = c(0, 1)[1+grepl("Python", as.character(LanguageHaveWorkedWith))],
        SQL = c(0, 1)[1+grepl("SQL", as.character(LanguageHaveWorkedWith))],
        R = c(0, 1)[1+grepl("R", as.character(LanguageHaveWorkedWith))],
        Julia = c(0, 1)[1+grepl("Julia", as.character(LanguageHaveWorkedWith))],
        Scala = c(0, 1)[1+grepl("Scala", as.character(LanguageHaveWorkedWith))],
        Java = c(0, 1)[1+grepl("Java", as.character(LanguageHaveWorkedWith))],
        Field = as.factor(ifelse(grepl("Dev", DevType), "Dev", 
                       ifelse(grepl("Data", DevType, ignore.case=TRUE), "Data", 
                              ifelse(grepl("Manager|Executive", DevType, ignore.case=TRUE), "Manager", 
                                     ifelse(grepl("site|admin", DevType, ignore.case=TRUE), "Sysadmin", "Other"))))),
        Gender = as.factor(ifelse(grepl("Man", Gender, ignore.case=F), "Man", ifelse(grepl("Woman", Gender, ignore.case=TRUE), "Women", ifelse(grepl("Non-binary", Gender, ignore.case=TRUE), "Non-binary", NA)))),
        EdLevel = as.factor(EdLevel),
        Age = as.factor(Age),
        ConvertedCompYearly = as.numeric(ConvertedCompYearly),
        US_State = as.factor(US_State),
        LanguageCount = as.integer(str_count(LanguageHaveWorkedWith, ";"))+1
        )

df_clean[df_clean == "Prefer not to say"] <- NA

```

## Descriptive Statistics

The below descriptive table shows the key statistics of the numeric variables under the discussion. The distribution of Years of coding is right-skewed with a mean of roughly 17 years, while the dispersion is relatively high (measured at SD = 10.82). The starters have 1 years of coding, while veterans with the most experience reported 50 years of coding. 

Regarding yearly compensation, US developers have an aggressively lognormal distribution in salaries, where the mean is 265.8 thousand USD, while the median is 130 thousand USD. 95% of the sample receives a yearly compensation lower than 500 thousand USD, and 5% higher than that maxing out at a whooping 22 billion USD a year. A minimum of 0 thousand USD wage means that there are observations having a single digit yearly compensation. According to [Minimum-wage.org](https://www.minimum-wage.org/federal), the federal minimum yearly minimum wage in 2021 was $15,080.00/year. Using that threshold, I've dropped rows with a yearly compensation below the minimum wage.

At last, a developer working in the US have experience in working with 4 programming languages in average. The distribution of the variable is about bell-shaped, with a standard-deviation of 2.76 and the maximum of 19 languages. Looking at the percentiles, 95% of the sample knows 9 or less programming languages, so two digit amounts are rare in the developer community.

```{r summary}

P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
datasummary( (`Years of coding` = YearsCode ) + 
             (`Yearly Compensation (K$)` = ConvertedCompYearlyK ) +
             (`Number of Languages Known` = LanguageCount) ~
             Mean + Median + SD + Min + Max + P05 + P95, 
             data = df_clean,
             title = 'Descriptive statistics') %>% 
      kable_styling(latex_options = c("HOLD_position","scale_down"))

df_clean <- df_clean[!(df_clean$ConvertedCompYearly < 15000),]
```
Next, to get a picture about the share coverage of the explanatory variables in our sample, We can visualize the joint distribution of Python and R in a tabular form. The table below suggests that around 36% of the full sample haven't worked with either of these languages. Among those who either worked with Python or not before, the share of R users are the same (30%). If we look at absolutes, the share of observations knowing Python is nearly double the share of those in R. Here we can already see a slight preference in R, and that oftentimes they go together in certain fields like Data Science. The question which I'm also after is that is it worth to study R in a perspective of compensation?

```{r}

df_clean %>%
  tabyl(Python, R, show_na = T) %>% 
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>% 
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_ns() %>%
  adorn_title("combined") %>%
  kable() %>% 
  kable_styling(latex_options = c("HOLD_position","scale_down"))

```

```{r distributions}

ggplot(aes(YearsCode), data = df_clean) + 
  geom_histogram(colour="firebrick4", fill="firebrick1", bins = 20) +
  geom_vline(aes(xintercept=mean(YearsCode, na.rm=T)),
           color="firebrick3", linetype="dashed", size=1, alpha = 0.5) +
  geom_text(aes(mean(YearsCode, na.rm=T), 700, label=paste0("Mean: ",round(mean(YearsCode, na.rm=T), 2))), hjust = -0.3) +
  labs(title = 'Years of Coding among Full-time Developers in the US',
       caption = 'Source: Stackoverflow Developer Survey 2021',
       x = 'Years of Coding',
       y = 'Frequency') +
  theme_bw()

```

```{r}

#log-normal dirstribution with a log mean of 5K dollars
ggplot(data = df_clean) + 
  geom_histogram(aes(lConvertedCompYearlyK), colour="firebrick4", fill="firebrick1", bins = 50) +
  labs(title = 'Log Compensation Level',
       subtitle = 'Log transformation yields bell-shaped curve',
       caption = 'Source: Stackoverflow Developer Survey 2021',
       x = 'Log Yearly Compensation (K$)',
       y = 'Frequency') +
  theme_bw()

```

```{r}

df_clean %>% filter(!is.na(Field)) %>% 
  ggplot(aes(x=Field, y=LanguageCount, fill=Field)) +
    geom_violin(width=1, alpha=0.5)+
    geom_boxplot(width=0.3) +
    labs(x = "",
         y = "No. Languages",
         subtitle = "Distributions across field types",
         title = "Total Coding Languages Known",
         caption = "Source: Stackoverflow Developer Survey 2021") +
  theme_bw() + 
  scale_fill_viridis_d(guide="none")

```

### Pattern of association

```{r scatter}

df_clean[,c("YearsCode", "ConvertedCompYearlyK", "LanguageCount")] %>% cor(use="complete.obs") %>% 
  kable(digits=3) %>% 
  kable_styling(latex_options = c("HOLD_position","scale_down"))

```

## Model

```{r models}

#relevels
df_clean <- df_clean %>% mutate(
  Field = relevel(Field, ref="Dev"),
  EdLevel = relevel(EdLevel, ref="Bachelor’s degree (B.A., B.S., B.Eng., etc.)"),
  Age = relevel(Age, ref="18-24 years old")  
)

reg1 <- feols(lConvertedCompYearlyK ~ Python + SQL + R + Julia + Scala + Java, data=df_clean, vcov = "hetero")

reg2 <- feols(lConvertedCompYearlyK ~ Python + SQL + R + Julia + Scala + Java + Field + CompSize, data = df_clean, vcov = "hetero")

reg3 <- feols(lConvertedCompYearlyK ~ Python + SQL + R + Julia + Scala + Java + Field + CompSize + EdLevel + Gender + Age, data = df_clean, vcov = "hetero")


msummary(list("Baseline" = reg1, "Company" = reg2, "Demographics" = reg3),
         fmt="%.2f",
         gof_omit = 'DF|Deviance|Log.Lik.|F|R2 Adj.|AIC|BIC|R2 Within|R2 Pseudo',
         stars=c('*' = .05, '**' = .01),
         estimate = "{estimate} ({std.error}){stars}",
         statistic = NULL,
         coef_rename = c("FieldData" = "Data",
                         "FieldManager" = "Manager",
                         "FieldOther" = "Other Field",
                         "FieldSysadmin" = "SysAdmin",
                         "CompSizemedium" = "Medium Company",
                         "CompSizesmall" = "Small Company",
                         "EdLevelAssociate degree (A.A., A.S., etc.)" = "Associate degree",
                         "EdLevelMaster’s degree (M.A., M.S., M.Eng., MBA, etc.)" = "Master's degree",
                         "EdLevelOther doctoral degree (Ph.D., Ed.D., etc.)" = "Doctoral degree",
                         "EdLevelPrimary/elementary school" = "Elementary School",
                         "EdLevelProfessional degree (JD, MD, etc.)" = "Professional degree",
                         "EdLevelSecondary school (e.g. American high school, German Realschule or Gymnasium, etc.)" = "Secondar School",
                         "EdLevelSome college/university study without earning a degree" = "University w/out degree",
                         "EdLevelSomething else" = "Other Education Level",
                         "GenderNon-binary" = "Non-binary",
                         "GenderWomen" = "Women",
                         "Age25-34 years old" = "25-34",
                         "Age35-44 years old" = "35-44",
                         "Age45-54 years old" = "45-54",
                         "Age55-64 years old" = "55-64",
                         "Age65 years or older" = "65+",
                         "AgeUnder 18 years old" = "18-"
                         ),
         title = "Coding Language Gap in the US") %>% 
        column_spec(1:3, width = "7em") %>% 
        kable_classic(full_width = F, position = "center" , latex_options = "hold_position")

```

## Robustness check / 'Heterogeneity analysis'

```{r robust}
```

## Conclusion

HERE COMES WHAT WE HAVE LEARNED AND WHAT WOULD STRENGHTEN AND WEAKEN OUR ANALYSIS.

## Appendix

Here comes all the results which are referenced and not essential for understanding the MAIN results.